---
- name: Initialize Docker Swarm on manager
  hosts: manager
  become: true
  tasks:
    - name: Initialize Docker Swarm
      shell: docker swarm init --advertise-addr {{ ansible_host }}
      register: swarm_init
      failed_when: "'Error' in swarm_init.stderr"

    - name: Get join token for workers
      shell: docker swarm join-token worker -q
      register: worker_token

    - name: Save worker join token
      set_fact:
        swarm_worker_token: "{{ worker_token.stdout }}"

- name: Join workers to Swarm
  hosts: workers
  become: true
  tasks:
    - name: Join Docker Swarm
      shell: docker swarm join --token {{ hostvars['manager']['swarm_worker_token'] }} {{ hostvars['manager']['ansible_host'] }}:2377
      register: join_output
      failed_when: "'Error' in join_output.stderr"
